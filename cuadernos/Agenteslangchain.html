
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>5. Los Agentes en LangChain &#8212; IA generativa</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'cuadernos/Agenteslangchain';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6. Introducción a ollama" href="ollama.html" />
    <link rel="prev" title="4. Introducción a la memoria con LangChain." href="memoria.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../introduccion.html">
  
  
  
  
  
  
    <p class="title logo__title">IA generativa</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">IA generativa</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="langchain.html">1. Langchain</a></li>
<li class="toctree-l1"><a class="reference internal" href="basesDatosLangchain.html">2. Conectores a Bases de Datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="cadenas.html">3. Las cadenas de LangChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="memoria.html">4. La memoria en LangChain</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">5. Los Agentes en LangChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="ollama.html">6. Ollama</a></li>
<li class="toctree-l1"><a class="reference internal" href="embeddings.html">7. Cómo hacer embeding's</a></li>
<li class="toctree-l1"><a class="reference internal" href="assistants/introAsistentes.html">8. La Api de OpenAI.</a></li>

<li class="toctree-l1"><a class="reference internal" href="conpago.html">10. Métodos de pago</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">IA generativa (Apéndices)</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="apendice.html">11. Apéndice</a></li>
<li class="toctree-l1"><a class="reference internal" href="videos.html">12. Vídeos interesantes</a></li>
<li class="toctree-l1"><a class="reference internal" href="apendices/Llama_2.html">13. Llama 2 en Colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="apendices/ModelosNER.html">14. Named Entity Recognition(NER)</a></li>
<li class="toctree-l1"><a class="reference internal" href="apendices/GeneracionTexto.html">15. Auto-Completado de texto</a></li>
<li class="toctree-l1"><a class="reference internal" href="apendices/gradio.html">16. Gradio</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Casos de uso</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="casosUso/EjemploLangGraph.html">17. Ejemplo con LangGraph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Índice de términos</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">Índice de términos</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Los Agentes en LangChain</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#como-funciona-react">5.1. ¿Cómo funciona ReAct?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#para-que-se-usa">5.2. ¿Para qué se usa?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#primer-caso-de-uso-de-los-agentes-langchain">5.3. Primer caso de uso de los agentes Langchain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crear-agente-potenciado-motor-busqueda">5.4. Crear agente potenciado motor búsqueda.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creacion-de-un-agente-programador-de-codigo">5.5. Creación de un agente programador de código.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crear-herramientas-personalizadas">5.6. Crear herramientas personalizadas.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#agentes-conversacionales-con-memoria">5.7. Agentes conversacionales con memoria.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cracion-agente-chatbot-con-memoria">5.8. Cración Agente Chatbot con memoria.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#agente-para-analisis-automatico-de-sql">5.9. Agente para análisis automático de SQL.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apendice">5.10. Apéndice.</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#serpapi">5.10.1. Serpapi.</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#por-que-usar-serpapi">5.10.1.1. <strong>¿Por qué usar SerpApi?</strong></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#como-funciona">5.10.1.2. <strong>¿Cómo funciona?</strong></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ejemplo-en-python">5.10.1.3. <strong>Ejemplo en Python</strong></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#casos-de-uso">5.10.1.4. <strong>Casos de uso</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#articulo-muy-interesante">5.10.2. Artículo muy interesante.</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="los-agentes-en-langchain">
<h1><span class="section-number">5. </span>Los Agentes en LangChain<a class="headerlink" href="#los-agentes-en-langchain" title="Link to this heading">#</a></h1>
<p id="index-0">Los Agentes son una pieza importante y potente de LangChain. Dentro de este apartado, vamos a ver los siguientes aspectos:</p>
<p>¿Qué son los agentes y su funcionamiento?
¿Cómo crear agentes asistidos con motores de búsqueda?
¿Cómo crear agentes programadores de código y conversacionales?
¿Cómo usar herramientas personalizadas por los agentes?
¿Cómo crear potentes agentes reales?</p>
<p>Los agentes son una de las partes más novedosas de LangChain , pero ofrecen un enorme potencial para aplicaciones basadas en LLM, y además de una manera muy sencilla.</p>
<p>Al combinar lo que ya aprendimos sobre Model IO, conexiones de datos y cadenas, ya hemos abordado aplicaciones similares a agentes, pero los agentes facilitan la creación de estas aplicaciones siendo además más robustas.</p>
<p>Básicamente, los agentes permiten a los LLM conectarse a herramientas (por ejemplo, Wikipedia, Calculadora, Búsqueda de Google, etc.) y llevar a cabo un enfoque estructurado para completar una <strong>tarea basada en ReAct</strong> (razonamiento y actuación).</p>
<p>ReAct es un enfoque de inteligencia artificial que combina <strong>razonamiento (Reasoning) y acción (Acting)</strong> para mejorar la toma de decisiones y la interacción con el entorno. Se utiliza en modelos de lenguaje y agentes de IA para mejorar su capacidad de resolver problemas de manera más eficiente.</p>
<section id="como-funciona-react">
<h2><span class="section-number">5.1. </span>¿Cómo funciona ReAct?<a class="headerlink" href="#como-funciona-react" title="Link to this heading">#</a></h2>
<p>El enfoque ReAct permite a un modelo de IA no solo <strong>generar respuestas</strong>, sino también <strong>razonar sobre ellas y actuar en consecuencia</strong>. Se basa en un ciclo de:</p>
<ol class="arabic simple">
<li><p><strong>Pensamiento</strong>: El modelo analiza la situación y razona sobre los pasos a seguir.</p></li>
<li><p><strong>Acción</strong>: Toma decisiones o consulta herramientas externas para obtener más información.</p></li>
<li><p><strong>Observación</strong>: Analiza los resultados de la acción y ajusta su razonamiento.</p></li>
</ol>
</section>
<section id="para-que-se-usa">
<h2><span class="section-number">5.2. </span>¿Para qué se usa?<a class="headerlink" href="#para-que-se-usa" title="Link to this heading">#</a></h2>
<p>ReAct se usa en:</p>
<ul class="simple">
<li><p><strong>Agentes conversacionales avanzados</strong> (como asistentes inteligentes que pueden planificar y razonar).</p></li>
<li><p><strong>Sistemas de búsqueda y recuperación de información</strong> (como IA que consulta bases de datos o la web).</p></li>
<li><p><strong>Juegos y simulaciones</strong> (donde los agentes de IA deben tomar decisiones en entornos dinámicos).</p></li>
</ul>
<p>Al Agente se le asigna una tarea y puede razonar qué herramientas son apropiadas para usar y luego puede utilizar esos resultados para continuar a través de una cadena interna hasta que resuelva la tarea.</p>
<p>Los agentes pueden ser extremadamente poderosos, especialmente si los combinamos con nuestras propias herramientas personalizadas.</p>
<p>Imagina un Agente con acceso a documentos corporativos internos y la capacidad de realizar búsquedas relevantes externas, de repente, tendrás un asistente corporativo muy poderoso con información interna y externa para responder preguntas (de clientes, de personal interno,…).</p>
<p>Ver el siguiente enlace:</p>
<p><a class="reference external" href="https://python.langchain.com/v0.1/docs/modules/agents/agent_types/">https://python.langchain.com/v0.1/docs/modules/agents/agent_types/</a></p>
<p>Una lista de herramientas disponibles, se pueden encontrar en:</p>
<p><a class="reference external" href="https://python.langchain.com/v0.1/docs/integrations/tools/">https://python.langchain.com/v0.1/docs/integrations/tools/</a></p>
<p><strong>NOTA</strong>: 👌 💖 Existe el <a class="reference internal" href="apendice.html#crewai"><span class="std std-ref">frimware denominado CrewaAI</span></a> que nos permite crear agentes de una forma fácil y eficiente.</p>
</section>
<section id="primer-caso-de-uso-de-los-agentes-langchain">
<h2><span class="section-number">5.3. </span>Primer caso de uso de los agentes Langchain<a class="headerlink" href="#primer-caso-de-uso-de-los-agentes-langchain" title="Link to this heading">#</a></h2>
<p>Vamos a instalar primero la siguiente librería de Python</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install -U langchain-community</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">langchain</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptTemplate</span><span class="p">,</span> <span class="n">SystemMessagePromptTemplate</span><span class="p">,</span><span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">HumanMessagePromptTemplate</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama3.2&quot;</span><span class="p">,</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:11434/v1&#39;</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;ollama&#39;</span><span class="p">,</span> <span class="c1"># required, but unused,</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span>

<span class="c1">#Recomendable temperatura a 0 para que el LLM no sea muy creativo, vamos a tener muchas herramientas a nuestra disposición y queremos que </span>
<span class="c1">#sea más determinista</span>
</pre></div>
</div>
</div>
</div>
<p><strong>NOTA</strong>: según la documentación de LangChain, Al compilar con LangChain, todos los pasos se rastrearán automáticamente en LangSmith. Para configurar LangSmith, solo necesitamos configurar las siguientes variables de entorno:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">LANGCHAIN_TRACING_V2</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
<span class="n">export</span> <span class="n">LANGCHAIN_API_KEY</span><span class="o">=</span><span class="s2">&quot;&lt;your-api-key&gt;&quot;</span>
</pre></div>
</div>
<p>Para el siguiente agente se necesita tener instalada la siguiente librería</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install numexpr</span>
</pre></div>
</div>
</div>
</div>
<p id="index-1">A continuación definimos la herramientas a las que tiene accesos el agente. En este caso le estamos dando la herramienta de llm-math, que es una herramienta para el cálculo matemático.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tools</span><span class="p">,</span><span class="n">initialize_agent</span><span class="p">,</span><span class="n">AgentType</span><span class="p">,</span><span class="n">create_react_agent</span><span class="p">,</span><span class="n">AgentExecutor</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># llm-math  es una herramienta para el cálculo matemático</span>
<span class="n">tools</span> <span class="o">=</span> <span class="n">load_tools</span><span class="p">([</span><span class="s2">&quot;llm-math&quot;</span><span class="p">,],</span><span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span> 
<span class="c1">#Lista de herramientas disponibles: https://python.langchain.com/v0.1/docs/integrations/tools/</span>
</pre></div>
</div>
</div>
</div>
<p>Podemos ver todos los tipos de agentes de los que podemos disponer, de la siguiente forma:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#dir(AgentType) #Vemos los diferentes tipos de agente a usar</span>
</pre></div>
</div>
</div>
</div>
<p>Ahora ya creamos el agente</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">ZERO_SHOT_REACT_DESCRIPTION</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">handle_parsing_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="c1">#Usamos el Zero Shot porque no estamos dando ningún ejemplo, solo pidiendo al agente hacer una tarea sin ejemplos previos</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resultado</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;Dime cuánto es 1598 multiplicado por 1983 y después sumas 1000&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Otra forma de utilizar un agente es mediante <strong>create_react_agent</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;Responde lo mejor que puedas usando tu conocimiento como LLM o bien las siguientes herramientas:</span>
<span class="si">{tools}</span>
<span class="s1">Utiliza el siguiente formato:</span>
<span class="s1">Pregunta: la pregunta de entrada que debes responder</span>
<span class="s1">Pensamiento: siempre debes pensar en qué hacer</span>
<span class="s1">Acción: la acción a realizar debe ser una de [</span><span class="si">{tool_names}</span><span class="s1">]</span>
<span class="s1">Entrada de acción: la entrada a la acción.</span>
<span class="s1">Observación: el resultado de la acción.</span>
<span class="s1">... (este Pensamiento/Acción/Introducción de Acción/Observación puede repetirse N veces,si no consigues el resultado tras 5 intentos, para la ejecución)</span>
<span class="s1">Pensamiento: ahora sé la respuesta final</span>
<span class="s1">Respuesta final: la respuesta final a la pregunta de entrada original</span>
<span class="s1">¡Comenzar! Recuerda que no siempre es necesario usar las herramientas</span>
<span class="s1">Pregunta: </span><span class="si">{input}</span>
<span class="s1">Pensamiento:</span><span class="si">{agent_scratchpad}</span><span class="s1">&#39;&#39;&#39;</span>

<span class="c1">#agent_scratchpad: El agente no llama a una herramienta solo una vez para obtener la respuesta deseada, sino que tiene una estructura que llama a las</span>
<span class="c1">#herramientas repetidamente hasta obtener la respuesta deseada. Cada vez que llama a una herramienta, en este campo se almacena cómo fue la </span>
<span class="c1">#llamada anterior, información sobre la llamada anterior y el resultado.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
<span class="n">agente</span> <span class="o">=</span> <span class="n">create_react_agent</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span><span class="n">tools</span><span class="p">,</span><span class="n">prompt</span><span class="p">)</span>
<span class="n">agent_executor</span> <span class="o">=</span> <span class="n">AgentExecutor</span><span class="p">(</span>
    <span class="n">agent</span><span class="o">=</span><span class="n">agente</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_intermediate_steps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">handle_parsing_errors</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">respuesta</span> <span class="o">=</span> <span class="n">agent_executor</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="s2">&quot;Dime cuánto es 1598 multiplicado por 1983&quot;</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">respuesta</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="crear-agente-potenciado-motor-busqueda">
<h2><span class="section-number">5.4. </span>Crear agente potenciado motor búsqueda.<a class="headerlink" href="#crear-agente-potenciado-motor-busqueda" title="Link to this heading">#</a></h2>
<p>Ver el apéndice de este tema, para conocer los servicios que nos ofrece esta herramienta. Para poder utilizarla se necesita primero bajar la librería. Lo hacemos de la siguiente manera:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install google-search-results</span>
</pre></div>
</div>
</div>
</div>
<p>Utilizando este procedimiento tendremos acceso a motores de búsqueda que serán mucho más potentes que solo  disponer de la información del LLM.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptTemplate</span><span class="p">,</span> <span class="n">SystemMessagePromptTemplate</span><span class="p">,</span><span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">HumanMessagePromptTemplate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tools</span><span class="p">,</span><span class="n">initialize_agent</span><span class="p">,</span><span class="n">AgentType</span><span class="p">,</span><span class="n">create_react_agent</span><span class="p">,</span><span class="n">AgentExecutor</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama3.2&quot;</span><span class="p">,</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:11434/v1&#39;</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;ollama&#39;</span><span class="p">,</span> <span class="c1"># required, but unused,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># leemos la api key para serpapi</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../SERPAPIKey.txt&#39;</span><span class="p">)</span>
<span class="n">serp_api_key</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Definir variable de entorno para que funcione correctamente:</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SERPAPI_API_KEY&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">serp_api_key</span> <span class="c1">#Si no está definida el error nos dará el nombre de la variable de entorno que espera</span>
</pre></div>
</div>
</div>
</div>
<p>Definimos las herramientas a las que el agente tendrá acceso</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Le indicamos qu eutilice la herramienta serpapi, que ya tenemos conexión pues hemos indicado nuestra api-key</span>
<span class="n">tools</span> <span class="o">=</span> <span class="n">load_tools</span><span class="p">([</span><span class="s2">&quot;serpapi&quot;</span><span class="p">,</span><span class="s2">&quot;llm-math&quot;</span><span class="p">,],</span><span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">ZERO_SHOT_REACT_DESCRIPTION</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;¿En qué año nació Einstein? ¿Cuál es el resultado de ese año multiplicado por 3?&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="creacion-de-un-agente-programador-de-codigo">
<h2><span class="section-number">5.5. </span>Creación de un agente programador de código.<a class="headerlink" href="#creacion-de-un-agente-programador-de-codigo" title="Link to this heading">#</a></h2>
<p>En este apartado vamos a crear un agente que genere código python para la tarea que nosotros le solicitemos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptTemplate</span><span class="p">,</span> <span class="n">SystemMessagePromptTemplate</span><span class="p">,</span><span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">HumanMessagePromptTemplate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tools</span><span class="p">,</span><span class="n">initialize_agent</span><span class="p">,</span><span class="n">AgentType</span><span class="p">,</span><span class="n">create_react_agent</span><span class="p">,</span><span class="n">AgentExecutor</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama3.2&quot;</span><span class="p">,</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:11434/v1&#39;</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;ollama&#39;</span><span class="p">,</span> <span class="c1"># required, but unused,</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span>

<span class="c1">#Recomendable temperatura a 0 para que el LLM no sea muy creativo, vamos a tener muchas herramientas a nuestra disposición y queremos que </span>
<span class="c1">#sea más determinista</span>
</pre></div>
</div>
</div>
</div>
<p>Importamos las siguientes librerías concretas para realizar estos trabajos</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install langchain_experimental</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_experimental.agents.agent_toolkits</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_python_agent</span>  <span class="c1"># agente para crear código python</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_experimental.tools.python.tool</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonREPLTool</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># creamos el agente</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">create_python_agent</span><span class="p">(</span><span class="n">tool</span><span class="o">=</span><span class="n">PythonREPLTool</span><span class="p">(),</span>
                           <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
                           <span class="n">agent</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">ZERO_SHOT_REACT_DESCRIPTION</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tenemos la siguiente lista de python desordenada con la que vamos a trabajar después</span>
<span class="n">lista_ejemplo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># hacemos trabajar al agente</span>
<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;ordena la lista </span><span class="si">{</span><span class="n">lista_ejemplo</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>La salida anterior ha generado una salida nula debido a que se ha excedido el tiempo de ejecución. Ello es debido a las limitaciones del equipo local con el que se está trabajando.</p>
<p>Ahora vamos a ver otro ejemplo pero utilizando un dataframe</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install openpyxl</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;datos_ventas_small.xlsx&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;¿Qué sentencias de código tendría que ejecutar para obtener la suma de venta total agregada por Línea de Producto? Este sería el dataframe </span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s1">, no tienes que ejecutar la sentencia, solo pasarme el código a ejecutar&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Línea Producto&#39;</span><span class="p">)[</span><span class="s1">&#39;Venta total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Como sugerencia, es mejor pedir la instrucción de python para conseguir el objetivo, que no que te de directamente el resultado.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;¿Qué sentencias de código tendría que ejecutar para tener una visualización con la librería Seaborn que agregue a nivel de Línea de Producto el total de venta? Este sería el dataframe </span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s1">, recuerda que no tienes que ejecutar la sentencia, solo pasarme el código a ejecutar&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install seaborn</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Venta total&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="crear-herramientas-personalizadas">
<h2><span class="section-number">5.6. </span>Crear herramientas personalizadas.<a class="headerlink" href="#crear-herramientas-personalizadas" title="Link to this heading">#</a></h2>
<p>Podemos definir nuestras propias herramientas ( tools ) para ser usadas por el agente.</p>
<p>Es muy importante definir bien el docstring (descripción de la función) puesto que en base a ello el agente seleccionará o no esa herramienta.</p>
<p>El uso de herramientas personalizadas expande el uso de los agentes, podríamos incluso definir herramientas que conecten con APIs internas de nuestra empresa para determinadas tareas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptTemplate</span><span class="p">,</span> <span class="n">SystemMessagePromptTemplate</span><span class="p">,</span><span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">HumanMessagePromptTemplate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tools</span><span class="p">,</span><span class="n">initialize_agent</span><span class="p">,</span><span class="n">AgentType</span><span class="p">,</span><span class="n">create_react_agent</span><span class="p">,</span><span class="n">AgentExecutor</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama3.2&quot;</span><span class="p">,</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:11434/v1&#39;</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;ollama&#39;</span><span class="p">,</span> <span class="c1"># required, but unused,</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span>

<span class="c1">#Recomendable temperatura a 0 para que el LLM no sea muy creativo, vamos a tener muchas herramientas a nuestra disposición y queremos que </span>
<span class="c1">#sea más determinista</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creamos nuestra herramienta personalizada</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">tool</span>
</pre></div>
</div>
</div>
</div>
<p>Definimos la función que implementa la herramienta que va a utilizar el agente.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">persona_amable</span> <span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Retorna la persona más amable. Se espera que la entrada esté vacía &quot;&quot; </span>
<span class="sd">    y retorna la persona más amable del universo&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="s2">&quot;Miguel Celebres&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>El LLM va a consultar del docstring de la función anterior, por si necesita utilizar esa herramienta personalizada para construir su respuesta.</p>
<p>Primero vamos a realizar el ejemplo, sin utilizar esa herramienta personalizada</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tools</span> <span class="o">=</span> <span class="n">load_tools</span><span class="p">([</span><span class="s2">&quot;wikipedia&quot;</span><span class="p">,</span><span class="s2">&quot;llm-math&quot;</span><span class="p">,],</span><span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">ZERO_SHOT_REACT_DESCRIPTION</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;¿Quién es la persona más amable del universo?&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Ahora vamos a indicar que utilice la herramienta personalziada que hemos construido anteriormente</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span> <span class="o">+</span> <span class="p">[</span><span class="n">persona_amable</span><span class="p">]</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">ZERO_SHOT_REACT_DESCRIPTION</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;¿Quién es la persona más amable del universo?&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Ahora vamos a ver otro ejemplo. En este caso, como nos podemos conectar a una determinada API interna</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">nombre_api_interna</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Conecta a la API_xx que realiza la tarea xx, debes usar esta API Key&#39;&#39;&#39;</span>
    <span class="c1">##Definir conexión a la API interna y devolver un resultado</span>
    <span class="k">return</span> <span class="n">resultado</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Supongamos</span> <span class="n">que</span> <span class="n">queremso</span> <span class="n">consultar</span> <span class="n">la</span> <span class="n">hora</span> <span class="n">actual</span> <span class="n">sin</span> <span class="n">más</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solicitud con las herramientas actuales no proporciona el resultado que queremos</span>
<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;¿Cuál es la hora actual?&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Lo que vamos a hacer es definir una herramienta personalizada que nos resuelva este problema</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">hora_actual</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Retorna la hora actual, debes usar esta función para cualquier consulta sobre la hora actual. Para fechas que no sean</span>
<span class="sd">    la hora actual, debes usar otra herramienta. La entrada está vacía y la salida retorna una string&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

<span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span> <span class="o">+</span> <span class="p">[</span><span class="n">hora_actual</span><span class="p">]</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">ZERO_SHOT_REACT_DESCRIPTION</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">handle_parsing_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Solicitud con las herramientas actuales SÍ proporciona el resultado que queremos</span>
<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;¿Cuál es la hora actual?&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="agentes-conversacionales-con-memoria">
<h2><span class="section-number">5.7. </span>Agentes conversacionales con memoria.<a class="headerlink" href="#agentes-conversacionales-con-memoria" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptTemplate</span><span class="p">,</span> <span class="n">SystemMessagePromptTemplate</span><span class="p">,</span><span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">HumanMessagePromptTemplate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tools</span><span class="p">,</span><span class="n">initialize_agent</span><span class="p">,</span><span class="n">AgentType</span><span class="p">,</span><span class="n">create_react_agent</span><span class="p">,</span><span class="n">AgentExecutor</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama3.2&quot;</span><span class="p">,</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:11434/v1&#39;</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;ollama&#39;</span><span class="p">,</span> <span class="c1"># required, but unused,</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span>

<span class="c1">#Recomendable temperatura a 0 para que el LLM no sea muy creativo, vamos a tener muchas herramientas a nuestra disposición y queremos que </span>
<span class="c1">#sea más determinista</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationBufferMemory</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">memory</span> <span class="o">=</span> <span class="n">ConversationBufferMemory</span><span class="p">(</span><span class="n">memory_key</span><span class="o">=</span><span class="s2">&quot;chat_history&quot;</span><span class="p">)</span> <span class="c1">#ponemos una denominada clave a la memoria &quot;chat_history&quot;</span>

<span class="n">tools</span> <span class="o">=</span> <span class="n">load_tools</span><span class="p">([</span><span class="s2">&quot;wikipedia&quot;</span><span class="p">,</span><span class="s2">&quot;llm-math&quot;</span><span class="p">,],</span><span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">CONVERSATIONAL_REACT_DESCRIPTION</span><span class="p">,</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;Dime 5 productos esenciales para el mantenimiento del vehículo.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Vamos a poner a prueba la memoria</span>
<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;Necesito la respuesta anterior en castellano&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="cracion-agente-chatbot-con-memoria">
<h2><span class="section-number">5.8. </span>Cración Agente Chatbot con memoria.<a class="headerlink" href="#cracion-agente-chatbot-con-memoria" title="Link to this heading">#</a></h2>
<p>Vamos acrear un Agente Chatbot con memoria a partir de sistema RAG con nuestra base de datos vectorial. Este agente va a combinar el potencial del BD vectorizadas con nuestros propios documentos y el resto de herramientas.</p>
<p>El agente debe verificar si la herramienta apropiada es la personalizada que creemos que obtendrá datos de la BBDD Vectorial o, sin embargo, debe usar otras herramientas como Wikipedia para consultar información o bien el propio conocimiento del LLM.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptTemplate</span><span class="p">,</span> <span class="n">SystemMessagePromptTemplate</span><span class="p">,</span><span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">HumanMessagePromptTemplate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tools</span><span class="p">,</span><span class="n">initialize_agent</span><span class="p">,</span><span class="n">AgentType</span><span class="p">,</span><span class="n">create_react_agent</span><span class="p">,</span><span class="n">AgentExecutor</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama3.2&quot;</span><span class="p">,</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:11434/v1&#39;</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;ollama&#39;</span><span class="p">,</span> <span class="c1"># required, but unused,</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span>

<span class="c1">#Recomendable temperatura a 0 para que el LLM no sea muy creativo, vamos a tener muchas herramientas a nuestra disposición y queremos que </span>
<span class="c1">#sea más determinista</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Podríamos establecer que tuviera memoria</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationBufferMemory</span>
<span class="n">memory</span> <span class="o">=</span> <span class="n">ConversationBufferMemory</span><span class="p">(</span><span class="n">memory_key</span><span class="o">=</span><span class="s2">&quot;chat_history&quot;</span><span class="p">)</span> <span class="c1">#ponemos una denominada clave a la memoria &quot;chat_history&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.vectorstores</span><span class="w"> </span><span class="kn">import</span> <span class="n">SKLearnVectorStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.retrievers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContextualCompressionRetriever</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.retrievers.document_compressors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLMChainExtractor</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Caragamos nuestros datos de una BD vectorial</span>

<span class="c1">#funcion_embedding = OpenAIEmbeddings(openai_api_key=api_key)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_ollama</span><span class="w"> </span><span class="kn">import</span> <span class="n">OllamaEmbeddings</span>

<span class="n">funcion_embedding</span> <span class="o">=</span> <span class="n">OllamaEmbeddings</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama3.2&quot;</span><span class="p">)</span>

<span class="n">persist_path</span><span class="o">=</span><span class="s2">&quot;BD/ejemplosk_embedding_db&quot;</span>
<span class="n">vector_store_connection</span> <span class="o">=</span> <span class="n">SKLearnVectorStore</span><span class="p">(</span><span class="n">embedding</span><span class="o">=</span><span class="n">funcion_embedding</span><span class="p">,</span> <span class="n">persist_path</span><span class="o">=</span><span class="n">persist_path</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">)</span>
<span class="n">compressor</span> <span class="o">=</span> <span class="n">LLMChainExtractor</span><span class="o">.</span><span class="n">from_llm</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
<span class="n">compression_retriever</span> <span class="o">=</span> <span class="n">ContextualCompressionRetriever</span><span class="p">(</span><span class="n">base_compressor</span><span class="o">=</span><span class="n">compressor</span><span class="p">,</span> <span class="n">base_retriever</span><span class="o">=</span><span class="n">vector_store_connection</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>Ahora vamos a definir una herramienta personalizada apoyada en la base de datos vectorial, de tal manera que el agente pueda utilizar esta herramienta que hemos definido.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">tool</span>

<span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">consulta_interna</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Retorna respuestas sobre la historia de España. Se espera que la entrada sea una cadena de texto</span>
<span class="sd">    y retorna una cadena con el resultado más relevante. Si la respuesta con esta herramienta es relevante,</span>
<span class="sd">    no debes usar ninguna herramienta más ni tu propio conocimiento como LLM&#39;&#39;&#39;</span>
    <span class="n">compressed_docs</span> <span class="o">=</span> <span class="n">compression_retriever</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">resultado</span> <span class="o">=</span> <span class="n">compressed_docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">page_content</span>
    <span class="k">return</span> <span class="n">resultado</span>

<span class="n">tools</span> <span class="o">=</span> <span class="n">load_tools</span><span class="p">([</span><span class="s2">&quot;wikipedia&quot;</span><span class="p">,</span><span class="s2">&quot;llm-math&quot;</span><span class="p">],</span><span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span>
<span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="o">+</span><span class="p">[</span><span class="n">consulta_interna</span><span class="p">]</span>

<span class="c1">#ahora ya tenemos nuestra herramienta</span>
</pre></div>
</div>
</div>
</div>
<p>Ahora ya estamos en condiciones de crear el agente y lo utilizamos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">CONVERSATIONAL_REACT_DESCRIPTION</span><span class="p">,</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># esto lo debería coger de nuestra herramienta personalizada</span>
<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;¿Qué periodo abarca cronológicamente en España el siglo de oro?&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;¿Qué pasó durante la misma etapa en Francia?&quot;</span><span class="p">)</span> <span class="c1">#Gracias a tener memoria compara en esas fechas qué ocurrió en Francia</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;¿Cuáles son las marcas de vehículos más famosas hoy en día?&quot;</span><span class="p">)</span> <span class="c1">#Pregunta que no podemos responder con nuestra BD Vectorial</span>
</pre></div>
</div>
</div>
</div>
<p><em>NOTA:</em> 🙋‍♂️😅 Como puede verse, los resultados que obtenemos no son los que buscamos, pero ello es debido a las limitaciones computacionales con las que estamos trabajando, por lo que este método es más bien didáctico y se expone para su conocimiento. En un mundo real, se debe utilizar un sistema computacional mucho más potente para obtener resultados acorde con lo que buscamos.</p>
</section>
<section id="agente-para-analisis-automatico-de-sql">
<h2><span class="section-number">5.9. </span>Agente para análisis automático de SQL.<a class="headerlink" href="#agente-para-analisis-automatico-de-sql" title="Link to this heading">#</a></h2>
<p>En este apartado vamos a crear un agente que haga consultas SQL a la base de datos, pero las consultas se las pedimos en lenguaje natural, no SQL. 😲🤑. En concreto lo que vamos a pedir es lo siguiente: ¿Cuántas ventas ha habido en el primer trimestre del 2025?, que equivale a la siguiente consulta:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">SUM</span><span class="p">(</span><span class="n">ventas</span><span class="p">)</span> <span class="n">AS</span> <span class="n">total_ventas</span>
<span class="n">FROM</span> <span class="n">ventas</span>
<span class="n">WHERE</span> <span class="n">fecha</span> <span class="o">&gt;=</span> <span class="s1">&#39;2025_01-01&#39;</span> <span class="n">AND</span> <span class="n">fecha</span> <span class="o">&lt;</span> <span class="s1">&#39;2025-04-01&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptTemplate</span><span class="p">,</span> <span class="n">SystemMessagePromptTemplate</span><span class="p">,</span><span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">HumanMessagePromptTemplate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tools</span><span class="p">,</span><span class="n">initialize_agent</span><span class="p">,</span><span class="n">AgentType</span><span class="p">,</span><span class="n">create_react_agent</span><span class="p">,</span><span class="n">AgentExecutor</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama3.2&quot;</span><span class="p">,</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:11434/v1&#39;</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;ollama&#39;</span><span class="p">,</span> <span class="c1"># required, but unused,</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span>

<span class="c1">#Recomendable temperatura a 0 para que el LLM no sea muy creativo, vamos a tener muchas herramientas a nuestra disposición y queremos que </span>
<span class="c1">#sea más determinista</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install mysql-connector-python</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">mysql.connector</span> <span class="c1">#pip install mysql-connector-python</span>
</pre></div>
</div>
</div>
</div>
<p>Para desarrollar y ejecutar este caso de uso, se neceita tener isntalado en nuestro equipo un servidor de base de datos MySql. Como no es el caso, nos vamos a limitar a mostrar el código, ya que todos los conceptos que en él se desarrollan, ya se han expuestos en capítulos anteriores.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../password_sql.txt&#39;</span><span class="p">)</span>
<span class="n">pass_sql</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="c1"># Configuración de la conexión a la base de datos</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>       
    <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">pass_sql</span><span class="p">,</span> 
    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>         
    <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;world&#39;</span>          
<span class="p">}</span>


<span class="c1"># Conectar a la base de datos</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="c1"># Definir la consulta manualmente: tengo una base de datos mysql en mi computadora local denominada &quot;world&quot; y una tabla &quot;Country&quot; </span>
<span class="c1">#sobre la que quiero hacer la suma de la población en la columna &quot;Population&quot; para el continente Asia (columna &quot;Continent&quot;)</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT SUM(Population)</span>
<span class="s2">    FROM Country</span>
<span class="s2">    WHERE Continent = &#39;Asia&#39;;</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="c1"># Ejecutar la consulta</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

<span class="n">suma_poblacion</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;La suma de la población del continente Asia es: </span><span class="si">{</span><span class="n">suma_poblacion</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># Creamos el agente SQL</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.agent_toolkits</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_sql_agent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.sql_database</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLDatabase</span>

<span class="c1"># Crear una cadena de conexión a la base de datos MySQL</span>
<span class="n">connection_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mysql+mysqlconnector://</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Crear una instancia de la base de datos SQL</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLDatabase</span><span class="o">.</span><span class="n">from_uri</span><span class="p">(</span><span class="n">connection_string</span><span class="p">)</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_sql_agent</span><span class="p">(</span>
    <span class="n">llm</span><span class="p">,</span>
    <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;Dime la población total de Asia&quot;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;Dime el promedio de la esperanza de vida por cada una de las regiones ordenadas de mayor a menor&quot;</span><span class="p">)</span>

<span class="c1"># Mostrar el resultado</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">])</span>

<span class="c1"># Para utilizar few-shoots para las consultas SQL: https://python.langchain.com/v0.1/docs/use_cases/sql/agents/</span>

</pre></div>
</div>
</section>
<section id="apendice">
<h2><span class="section-number">5.10. </span>Apéndice.<a class="headerlink" href="#apendice" title="Link to this heading">#</a></h2>
<section id="serpapi">
<span id="index-2"></span><h3><span class="section-number">5.10.1. </span>Serpapi.<a class="headerlink" href="#serpapi" title="Link to this heading">#</a></h3>
<p><strong>SerpApi</strong> es una API que permite extraer datos de los resultados de búsqueda de Google y otros motores de búsqueda sin necesidad de realizar scraping manualmente. Facilita la obtención de resultados de Google Search, Google Images, Google News, Google Maps, Google Shopping, YouTube y más, de una manera estructurada y libre de bloqueos.</p>
<section id="por-que-usar-serpapi">
<h4><span class="section-number">5.10.1.1. </span><strong>¿Por qué usar SerpApi?</strong><a class="headerlink" href="#por-que-usar-serpapi" title="Link to this heading">#</a></h4>
<ol class="arabic simple">
<li><p><strong>Evita bloqueos</strong>: Google implementa restricciones y CAPTCHA para prevenir el scraping, pero SerpApi maneja esto automáticamente.</p></li>
<li><p><strong>Datos estructurados</strong>: Los resultados se devuelven en formato JSON, lo que facilita su procesamiento.</p></li>
<li><p><strong>Compatibilidad con múltiples motores de búsqueda</strong>: Además de Google, soporta Bing, DuckDuckGo, Yahoo, entre otros.</p></li>
<li><p><strong>Alta velocidad y escalabilidad</strong>: Permite realizar múltiples solicitudes de búsqueda de forma eficiente.</p></li>
</ol>
</section>
<section id="como-funciona">
<h4><span class="section-number">5.10.1.2. </span><strong>¿Cómo funciona?</strong><a class="headerlink" href="#como-funciona" title="Link to this heading">#</a></h4>
<p>Para usar SerpApi, necesitas:</p>
<ol class="arabic simple">
<li><p><strong>Crear una cuenta</strong> en <a class="reference external" href="https://serpapi.com/">SerpApi</a>.</p></li>
<li><p><strong>Obtener una API Key</strong> para autenticar solicitudes.</p></li>
<li><p><strong>Realizar peticiones HTTP</strong> al endpoint de búsqueda con los parámetros deseados.</p></li>
</ol>
</section>
<section id="ejemplo-en-python">
<h4><span class="section-number">5.10.1.3. </span><strong>Ejemplo en Python</strong><a class="headerlink" href="#ejemplo-en-python" title="Link to this heading">#</a></h4>
<p>Aquí tienes un ejemplo de cómo hacer una búsqueda en Google usando la API de SerpApi con Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;ChatGPT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hl&quot;</span><span class="p">:</span> <span class="s2">&quot;es&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gl&quot;</span><span class="p">:</span> <span class="s2">&quot;es&quot;</span><span class="p">,</span>
    <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="s2">&quot;TU_API_KEY&quot;</span>
<span class="p">}</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://serpapi.com/search&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>Este código devuelve los resultados de búsqueda de Google en JSON.</p>
</section>
<section id="casos-de-uso">
<h4><span class="section-number">5.10.1.4. </span><strong>Casos de uso</strong><a class="headerlink" href="#casos-de-uso" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Monitoreo de rankings en SEO.</p></li>
<li><p>Seguimiento de precios en Google Shopping.</p></li>
<li><p>Extracción de datos de Google Maps para negocios locales.</p></li>
<li><p>Automatización de investigaciones en Google News.</p></li>
</ul>
<p><strong>NOTA:</strong> 👍 👌 Esta herramienta es de pago pero en el momento de redactar estas líneas, existe una versión gratuita que permite hacer 100 búsquedas al mes sin tener que pagar.</p>
<ul class="simple">
<li><p><a href="https://serpapi.com/" target="_blank"> Página oficial de serpapi </a></p></li>
</ul>
</section>
</section>
<section id="articulo-muy-interesante">
<h3><span class="section-number">5.10.2. </span>Artículo muy interesante.<a class="headerlink" href="#articulo-muy-interesante" title="Link to this heading">#</a></h3>
<p id="index-3">A continuación se indica un enlace para ver un artículo muy interesante sobre los agentes de LangChain</p>
<ul class="simple">
<li><p><a href="https://www.datacamp.com/es/tutorial/building-langchain-agents-to-automate-tasks-in-python" target="_blank"> Trabajar con Agentes en LangChain </a></p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./cuadernos"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="memoria.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">4. </span>Introducción a la memoria con LangChain.</p>
      </div>
    </a>
    <a class="right-next"
       href="ollama.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">6. </span>Introducción a ollama</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#como-funciona-react">5.1. ¿Cómo funciona ReAct?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#para-que-se-usa">5.2. ¿Para qué se usa?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#primer-caso-de-uso-de-los-agentes-langchain">5.3. Primer caso de uso de los agentes Langchain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crear-agente-potenciado-motor-busqueda">5.4. Crear agente potenciado motor búsqueda.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creacion-de-un-agente-programador-de-codigo">5.5. Creación de un agente programador de código.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crear-herramientas-personalizadas">5.6. Crear herramientas personalizadas.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#agentes-conversacionales-con-memoria">5.7. Agentes conversacionales con memoria.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cracion-agente-chatbot-con-memoria">5.8. Cración Agente Chatbot con memoria.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#agente-para-analisis-automatico-de-sql">5.9. Agente para análisis automático de SQL.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apendice">5.10. Apéndice.</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#serpapi">5.10.1. Serpapi.</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#por-que-usar-serpapi">5.10.1.1. <strong>¿Por qué usar SerpApi?</strong></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#como-funciona">5.10.1.2. <strong>¿Cómo funciona?</strong></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ejemplo-en-python">5.10.1.3. <strong>Ejemplo en Python</strong></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#casos-de-uso">5.10.1.4. <strong>Casos de uso</strong></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#articulo-muy-interesante">5.10.2. Artículo muy interesante.</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Francisco Rodríguez
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>